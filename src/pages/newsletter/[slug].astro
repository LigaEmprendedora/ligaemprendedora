---
import BaseLayout from "../../layouts/BaseLayout.astro";
import Header from "../../components/Header.astro";
import Footer from "../../components/Footer.astro";
import NewsletterLayout from "../../layouts/NewsletterLayout.astro";
import { getCollection, type CollectionEntry } from "astro:content";

type NewsletterEntry = CollectionEntry<"newsletter">;

export async function getStaticPaths() {
  const posts = await getCollection("newsletter");

  return posts.map((post: NewsletterEntry) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props as { post: NewsletterEntry };
const { Content } = await post.render();
const fm = post.data;

const allPosts = await getCollection("newsletter");

const relatedPosts = (allPosts as NewsletterEntry[])
  .filter((p: NewsletterEntry) => p.slug !== post.slug)
  .sort((a: any, b: any) =>
    a.data.date && b.data.date && a.data.date < b.data.date ? 1 : -1
  )
  .slice(0, 4);
---

<BaseLayout title={fm.title} description={fm.description}>
  <div class="flex min-h-screen flex-col bg-[#f4f6fa]">
    <Header />

    <main class="flex-1">
      <section class="px-4 py-10 md:px-6">
        <div
          class="mx-auto max-w-6xl grid gap-10
                 md:grid-cols-[minmax(0,2.2fr)_minmax(260px,0.8fr)]
                 items-start"
        >
          <!-- COLUMNA PRINCIPAL: ARTÍCULO -->
          <NewsletterLayout frontmatter={fm}>
            <Content />
          </NewsletterLayout>

          <!-- SIDEBAR: OTRAS NOTAS -->
          <aside class="space-y-8">
            <section>
              <h2 class="text-xs font-semibold uppercase tracking-[0.25em] text-[#6b7280]">
                Más de la Liga
              </h2>
              <div class="mt-4 space-y-4">
                {relatedPosts.map((item: NewsletterEntry) => (
                  <article class="border-b border-[#e5e7eb] pb-3 last:border-b-0">
                    <a
                      href={`/newsletter/${item.slug}`}
                      class="text-sm font-semibold text-[#111827] hover:text-[#e3412b]"
                    >
                      {item.data.title}
                    </a>
                    {item.data.category && (
                      <p class="mt-1 text-[11px] uppercase tracking-[0.18em] text-[#9ca3af]">
                        {item.data.category}
                      </p>
                    )}
                  </article>
                ))}
              </div>
            </section>

            <section>
              <h2 class="text-xs font-semibold uppercase tracking-[0.25em] text-[#6b7280]">
                Lo más reciente
              </h2>
              <div class="mt-4 space-y-3">
                {(allPosts as NewsletterEntry[])
                  .slice()
                  .sort((a: any, b: any) =>
                    a.data.date && b.data.date && a.data.date < b.data.date ? 1 : -1
                  )
                  .slice(0, 5)
                  .map((item: NewsletterEntry) => (
                    <a
                      href={`/newsletter/${item.slug}`}
                      class="block text-xs text-[#4b5563] hover:text-[#e3412b]"
                    >
                      {item.data.title}
                    </a>
                  ))}
              </div>
            </section>
          </aside>
        </div>
      </section>
    </main>

    <Footer />
  </div>
</BaseLayout>
